# Backend Integration Requirements for fcagent-frontend

## Rule Name:
`frontend-integration-backend-changes`

## Description:
This document outlines the critical backend API changes and considerations necessary to ensure full functionality and support for the `fcagent-frontend` application. It is based on the detailed `backend_requirements.md` file (located in the `fcagent-frontend` repository) and discussions regarding the frontend-backend interaction.

**Key Architectural Context:**

*   **Frontend Application (`fcagent-frontend`):**
    *   Deployed at: `https://fcagent-frontend.up.railway.app` (or the current equivalent frontend deployment URL).
    *   Communicates with the backend via the `NEXT_PUBLIC_API_URL` environment variable, which points to the `main-service`.
*   **Backend API Gateway (`main-service`):**
    *   Publicly accessible at: `https://fcagent.up.railway.app`.
    *   The FastAPI application within this service listens internally on the port specified by its `PORT` environment variable (e.g., `8080`).
    *   Handles initial API requests, authentication (e.g., JWT), and CORS.
    *   CORS `ALLOWED_ORIGINS` environment variable **must** include the frontend's deployment URL (e.g., `https://fcagent-frontend.up.railway.app`).
    *   The `ORCHESTRATOR_SERVICE_URL` environment variable in this service points to the internal address of the `orchestrator-service`.
*   **Backend Core Logic (`orchestrator-service`):**
    *   The FastAPI application within this service listens internally on the port specified by its `PORT` environment variable (e.g., `8002`).
    *   Handles core support request creation, message handling, and agent interaction logic.
    *   It is primarily accessed via the `main-service`, not directly by the frontend.

## Core Backend Requirements (Summarized from `backend_requirements.md`):

**Please refer to the `backend_requirements.md` file in the `fcagent-frontend` repository for complete details and rationale for each point.** A summary of essential changes is provided below:

### 1. Ticket / Contact Linking
*   **Requirement:** Enable associating a user's email address or Telegram ID with an existing `ticketId` *after* the initial support request has been created.
*   **Impacted Service(s):** Primarily `orchestrator-service`.
*   **Suggested Action (from `backend_requirements.md`):**
    *   **Option A (Recommended):** Modify the existing `PUT /requests/{request_id}` endpoint in `orchestrator_service/main.py`. This involves adding optional `linked_email` and `linked_telegram_id` fields to the `SupportRequestUpdate` Pydantic model in `orchestrator_service/models.py` and updating the endpoint logic to save this information.
    *   **Option B:** Create a new dedicated endpoint, e.g., `POST /requests/{request_id}/link-contact`, with a specific request body model.

### 2. Agent Name in Message Response
*   **Requirement:** Include the name or type of the specific AI agent (e.g., "TriageAgent", "APIImplementationAgent") who authored a particular message in the API response for messages.
*   **Impacted Service(s):** `orchestrator-service`.
*   **Suggested Action (from `backend_requirements.md`):**
    *   **Option A:** When an agent message (`SupportMessage` record) is created, include the agent's name/type in the `request_metadata` field of that message.
    *   **Option B:** Add an `agent_name: Optional[str]` field directly to the `SupportMessageResponse` Pydantic model and populate it when returning agent messages.

### 3. User Authentication / User ID Handling
*   **Requirement:** Transition from the current temporary `guestUserId` (generated by the frontend) and placeholder `user_id: 0` to a system that uses a proper, authenticated `user_id`.
*   **Impacted Service(s):** `main-service` (for implementing/managing the authentication flow) and `orchestrator-service` (for associating requests and messages with the authenticated `user_id`).
*   **Suggested Action (from `backend_requirements.md`):**
    *   Implement or finalize a robust authentication flow (e.g., JWT using an endpoint like `/token` in the `main-service`).
    *   The frontend will then send the authenticated user's ID (obtained from the auth service/token).
    *   The backend services (`main-service` for validation, `orchestrator-service` for data association) must use this authenticated `user_id` when creating, querying, and managing support requests and messages, replacing the current placeholder `user_id: 0` and guest ID usage.

### 4. Real-time Agent Replies (Optional Enhancement)
*   **Requirement:** Enhance user experience by pushing agent replies to the frontend in real-time, rather than relying solely on frontend polling.
*   **Impacted Service(s):** `orchestrator-service` or potentially the `main-service` (API Gateway) if it handles the real-time connection management.
*   **Suggested Action (from `backend_requirements.md`):** Explore and implement WebSockets or Server-Sent Events (SSE) to facilitate real-time communication of new messages to the connected frontend clients.

---

**Note to Backend Team:** This document provides a high-level overview. Please ensure to consult the `backend_requirements.md` file for a more comprehensive understanding of each requirement, including specific model changes and endpoint considerations. Your attention to these items is crucial for the successful integration and operation of the `fcagent-frontend`. 